<!DOCTYPE html>
<html manifest="viewer3d.manifest">

<head>
    <title>Viewer 3D Demo : @buildnum@</title>
    <meta name="viewport" content="width=device-width, target-densityDpi=device-dpi, minimum-scale=1.0, maximum-scale=1.0" />
    <meta charset="utf-8">

    <link rel="stylesheet" href="style.css" type="text/css">
    <link rel="stylesheet" href="pagestyle.css" type="text/css">
    <link rel="stylesheet" href="gui/AlertBox.css" type="text/css">
    <link rel="stylesheet" href="gui/DocumentStructurePanel.css" type="text/css">
    <link rel="stylesheet" href="gui/ContextMenu.css" type="text/css">

    <script src="viewer3D.min.js"></script>
    <script src="main.js"></script>
	<script type="text/javascript" src="../../assets/sys_resources/js/jquery.js"></script>
    <!--<script type="text/javascript" src="../../js/jquery.js"></script>-->

    <script>
        function initializeViewer() {
            // Check if canvas and doc panel click behaviors have been provided.
            //
            var config = {};
            var canvasConfig = getParameterByName("canvasConfig");
            if (canvasConfig) {
                config.canvasConfig = JSON.parse(canvasConfig);
            }

            var docStructureConfig = getParameterByName("docConfig");
            if (docStructureConfig) {
                config.docStructureConfig = JSON.parse(docStructureConfig);
            }

            // Create the 3d viewer with this config parameters.
            // TODO:  This global viewer needs to be removed - it's being accessed by SvfLoader.pathToURL()
            //        For now, keep it global.
            //
            viewer = new METADATA.GuiViewer3D('viewer3d', config);
            viewer.initialize();

            if (getParameterByName("showOverlaysWhileMoving") == "false") {
                viewer.impl.toggleOverlaysWhileMoving(false);
            }

            // Check if a local file has been provided.  If it has, load the file
            // immediately.
            //
            var fileid = getParameterByName("id");
            if (fileid == null || fileid == "")
            {
                alert("未接收到模型ID！");
                return;
            }

            openmodel(fileid);
        }

        function openmodel(fileid)
        {
            var dataurl = "../data/" + fileid + "/data.html";
            var datamanifesturl = "../data/"+fileid+"/data.manifest";
            $.get(dataurl, function(test){
                var dataframe = document.getElementById("data");
                dataframe.src = dataurl;
                $.get(datamanifesturl, function(data) {
                    var index1 = data.indexOf(".svf");
                    if (index1 > 0)
                    {
                        var subdata = data.substr(0, index1+4);
                        var index0 = subdata.lastIndexOf("\n");
                        if (index0 > 0)
                        {
                            var indexpath = subdata.substr(index0+1);
                            if (indexpath == null || indexpath == "")
                            {
                                alert("未能找到模型文件！");
                                return;
                            }

                            if(indexpath) {
                                indexpath = "../data/" + fileid + "/" + indexpath;
                                viewer.load(indexpath);
                            }
                        }
                        else
                        {
                            alert("未能找到模型文件！");
                            return;
                        }

                    }
                    else
                    {
                        alert("未能找到模型文件！");
                        return;
                    }
                });
            });

        }

        function loadDocument(viewer, auth, documentId, initialItemId)
        {
            // Load the document.  Once loaded, find the item requested, and load its svf.  If not,
            // just find the first svf and load that.
            //
            var urn = documentId.substr(4);
            var path = VIEWING_URL + '/bubbles/' + urn;

            METADATA.Document.load(path, auth,
                function(document) { // onLoadCallback
                    var rootItem = document.getRootItem();
                    if(initialItemId) {
                        var geometryItems = METADATA.Document.getSubItemsWithProperties(document.getRootItem(), {'guid':initialItemId}, true);
                        if(geometryItems.length > 0) {
                            rootItem = geometryItems[0];
                        }
                    }

                    var svfItems = METADATA.Document.getSubItemsWithProperties(rootItem, {'mime':'application/autodesk-svf'}, true);
                    if(svfItems.length > 0) {
                        viewer.load(svfItems[0].urn);
                    }
                },
                function(msg) { // onErrorCallback
                    var container = document.getElementById('viewer2d');
                    if (container) {
                        AlertBox.displayError(container, "LOAD Error: " + msg);
                    }
                }
            );
        }
		
    </script>
</head>

<body onload="initializeViewer();" oncontextmenu="return false;">
    <div id="viewer3d" style="position:absolute; width:100%; height:100%; overflow: hidden;"></div>
	<div style="display:none">
		<iframe id="data" src=""></iframe>
	</div>
</body>

</html>
