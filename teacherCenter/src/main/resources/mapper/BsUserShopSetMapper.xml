<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xue.dao.BsUserShopSetMapper" >
  <resultMap type="com.xue.dto.OpenCourseRecodeResult" id="BaseResultMap">
      <result  column="id" property="id" jdbcType="VARCHAR" />
      <result column="student_id" property="studentId" jdbcType="VARCHAR" />
      <result column="student_name" property="studentName" jdbcType="VARCHAR" />
      <result column="mobile" property="mobile" jdbcType="VARCHAR" />
      <result column="shop_Name" property="openProject" jdbcType="VARCHAR" />
      <result column="create_Time" property="openTime" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="BsUserShopResultMap" type="com.xue.model.BsUserShopSet" >
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="shop_id" property="shopId" jdbcType="VARCHAR" />
    <result column="stu_id" property="stuId" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="statu" property="statu" jdbcType="INTEGER" />
    <result column="major_id" property="majorId" jdbcType="VARCHAR" />
    <result column="major_name" property="majorName" jdbcType="VARCHAR" />
     <result column="classes_id" property="classesId" jdbcType="VARCHAR" />
    <result column="classes_name" property="classesName" jdbcType="VARCHAR" />
    <result column="shop_price" property="shopPrice" jdbcType="REAL" />
  </resultMap>
  <resultMap id="StudentHighScoreResultMap" type="com.xue.model.StudentHighScore" >
    <result column="score" property="score" jdbcType="REAL" />
    <result column="months" property="months" jdbcType="VARCHAR" />
    <result column="className" property="className" jdbcType="VARCHAR" />
    <result column="classId" property="classId" jdbcType="VARCHAR" />
  </resultMap>
  
  
  <sql id="Base_Column_List" >
    SHOP_ID, SHOP_NAME, SHOP_DESC, SHOP_NUM, SHOP_PRICE, SHOP_STATE, SHOP_TYPE, SHOP_PIC, 
    VALIDITY, DISCOUNT, ORDER_BY, PAY_WAY, PAY_SOURCE, IS_DEL, PAY_NUMBER, STUDY_TIME, 
    MAJOR_ID, MAJOR_NAME, SUBJECT_ID, SUBJECT_NAME, CLASSES_ID, CLASSES_NAME, CLASSES_ORDER, 
    DESCRIPTION, PHASE_NUMBER, LIVE_URL
  </sql>
  <select id="findShowMajor" resultMap="BsUserShopResultMap" parameterType="java.lang.String"> 
		    SELECT
				buss.*
			FROM
				bs_user_shop_set buss
			WHERE
				buss.user_id = #{userId,jdbcType=VARCHAR}
			AND YEAR (buss.create_time) = YEAR (NOW())
			GROUP BY
				buss.major_id
  </select>
  
  <select id="getAchivementInfo" resultMap="StudentHighScoreResultMap" parameterType="com.xue.vo.query.BsUserShopSetQuery">
	    SELECT
			SUM(buss.shop_price) AS score,
			DATE_FORMAT(buss.create_time, '%m') months,
			buss.classes_name AS className,
			buss.classes_id as classId
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = #{userId,jdbcType=VARCHAR} AND buss.major_id = #{majorId,jdbcType=VARCHAR}
		AND YEAR(buss.create_time)=YEAR(NOW())
		GROUP BY
			months,
			buss.classes_id
  </select>
  <select id="getMouthAchivementInfo" resultMap="StudentHighScoreResultMap" parameterType="com.xue.vo.query.BsUserShopSetQuery">
	     SELECT
			SUM(buss.shop_price) AS score,
			DATE_FORMAT(buss.create_time, '%m') months,
			buss.classes_name AS className,
			buss.classes_id as classId
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = #{userId,jdbcType=VARCHAR} AND buss.major_id = #{majorId,jdbcType=VARCHAR}
		AND month(buss.create_time)=#{statu,jdbcType=INTEGER}
		GROUP BY
			months,
			buss.classes_id
  </select>
     
    <select id="getMouthAchivementInfoByClassId" resultMap="StudentHighScoreResultMap" parameterType="com.xue.vo.query.BsUserShopSetQuery">
	    SELECT
			SUM(buss.shop_price) AS score,
			DATE_FORMAT(buss.create_time, '%m') months,
			buss.classes_name AS className,
			buss.classes_id as classId
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = #{userId,jdbcType=VARCHAR} AND buss.major_id = #{majorId,jdbcType=VARCHAR}
		AND month(buss.create_time)=#{statu,jdbcType=INTEGER}
		GROUP BY
			buss.classes_id
  </select>
    <select id="getAchivementInfoByClassId" resultMap="StudentHighScoreResultMap" parameterType="com.xue.vo.query.BsUserShopSetQuery">
	    SELECT
			SUM(buss.shop_price) AS score,
			DATE_FORMAT(buss.create_time, '%m') months,
			buss.classes_name AS className,
			buss.classes_id as classId
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = #{userId,jdbcType=VARCHAR} AND buss.major_id = #{majorId,jdbcType=VARCHAR}
		AND YEAR(buss.create_time)=YEAR(NOW())
		GROUP BY
			buss.classes_id
  </select>
   <select id="getAchivementInfoByMonth" resultMap="StudentHighScoreResultMap">
	    SELECT
			SUM(buss.shop_price) AS score,
			DATE_FORMAT(buss.create_time, '%m') months,
			buss.classes_name AS className,
		  	buss.classes_id as classId
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = 'teacher' AND buss.major_id = 'kl941809Z9Fz10Xe1Jyj'
		AND YEAR(buss.create_time)=YEAR(NOW())
		GROUP BY
		months
  </select>
   <select id="findAllPayInfo" resultType="java.lang.Integer" parameterType="java.lang.String" >
	    SELECT
			SUM(buss.shop_price) AS score
		FROM
			bs_user_shop_set buss
		WHERE
			buss.user_id = #{userId,jdbcType=VARCHAR}
		AND YEAR (buss.create_time) = YEAR (NOW())
  </select>
  
   <select id="findAllMajor" resultMap="BsUserShopResultMap" parameterType="java.lang.String" >
    select 
    *
    from bs_user_shop_set
    where user_id = #{userId,jdbcType=VARCHAR} and statu =1
  </select>
  
   <select id="queryBsUserShopSet" resultMap="BsUserShopResultMap" parameterType="com.xue.model.BsUserShopSet" >
    select 
       id,user_id,shop_id,stu_id,create_time,statu,major_id,major_name
    from bs_user_shop_set
    <where>
		<if test="userId !=null and userId != ''">  
	     	 AND user_id =  #{userId,jdbcType=VARCHAR} 
		</if> 
		<if test="shopId !=null and shopId != ''">  
	     	 AND shop_id =  #{shopId,jdbcType=VARCHAR} 
		</if>
		<if test="stuId !=null and stuId != ''">  
	     	 AND stu_id =  #{stuId,jdbcType=VARCHAR} 
		</if>
	</where> 
  </select>
  
  
  <select id="findMajor" resultMap="BsUserShopResultMap" parameterType="java.lang.String" >
    select 
    *
    from bs_user_shop_set
    where user_id = #{userId,jdbcType=VARCHAR} and statu =1 GROUP BY major_id 
  </select>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from shop
    where SHOP_ID = #{shopId,jdbcType=VARCHAR}
  </select>
  
  <select id="findSubClassByDetailId" resultMap="BaseResultMap" parameterType="com.xue.vo.query.ShopQuery" >
    select 
    <include refid="Base_Column_List" />
    from shop
    <where>
		<if test="majorId !=null and majorId != ''">  
	     	 AND MAJOR_ID =  #{majorId,jdbcType=VARCHAR} 
		</if> 
		<if test="subjectId !=null and subjectId != ''">  
	     	 AND SUBJECT_ID =  #{subjectId,jdbcType=VARCHAR} 
		</if>
		<if test="shopType !=null and shopType != ''">  
	     	 AND SHOP_TYPE =  #{shopType,jdbcType=VARCHAR} 
		</if>
	</where>
		ORDER BY SHOP_PRICE ASC
  </select>
   <select id="findByShopQuery" resultMap="BaseResultMap" parameterType="com.xue.vo.query.ShopQuery" >
      SELECT 
	  s.*
	  FROM
		  shop s
	  INNER JOIN student_shop_set sss ON s.SHOP_ID = sss.SHOP_ID AND s.SHOP_TYPE = 2
	  AND sss.STUDENT_ID =  #{studentId,jdbcType=VARCHAR}  AND s.MAJOR_ID = #{majorId,jdbcType=VARCHAR}
  </select>
  <select id="findByFreeShopQuery" resultMap="BaseResultMap" parameterType="com.xue.vo.query.ShopQuery" >
	    SELECT
			s.*
		FROM
			shop s
		WHERE
			s.MAJOR_ID = #{majorId,jdbcType=VARCHAR}
		AND s.SHOP_TYPE = 9 ORDER BY ORDER_BY
  </select>
  <select id="findShopByQuery" resultMap="BaseResultMap" parameterType="com.xue.vo.query.ShopQuery" >
    select 
    <include refid="Base_Column_List" />
    from shop
    <where>
        <if test="shopTime !=null and shopTime != ''">  
	     	 AND shop_time =  #{shopTime,jdbcType=VARCHAR} 
		</if> 
		<if test="shopType !=null and shopType != ''">  
	     	 AND shop_type =  #{shopType,jdbcType=VARCHAR} 
		</if>  
		<if test="majorId !=null and majorId != ''">  
	     	 AND MAJOR_ID =  #{majorId,jdbcType=VARCHAR} 
		</if> 
		<if test="subjectId !=null and subjectId != ''">  
	     	 AND SUBJECT_ID =  #{subjectId,jdbcType=VARCHAR} 
		</if>
		<if test="classesId !=null and classesId != ''">  
	     	 AND CLASSES_ID =  #{classesId,jdbcType=VARCHAR} 
		</if>
	</where>  limit #{startNum,jdbcType=INTEGER},5
  </select>
  
  <select id="findShopByQueryCount"  resultType="java.lang.Integer" parameterType="com.xue.vo.query.ShopQuery">
   select 
      count(*)
    from shop
    <where>
        <if test="shopTime !=null and shopTime != ''">  
	     	 AND shop_time =  #{shopTime,jdbcType=VARCHAR} 
		</if> 
		<if test="shopType !=null and shopType != ''">  
	     	 AND shop_type =  #{shopType,jdbcType=VARCHAR} 
		</if>  
		<if test="majorId !=null and majorId != ''">  
	     	 AND MAJOR_ID =  #{majorId,jdbcType=VARCHAR} 
		</if> 
		<if test="subjectId !=null and subjectId != ''">  
	     	 AND SUBJECT_ID =  #{subjectId,jdbcType=VARCHAR} 
		</if>
		<if test="classesId !=null and classesId != ''">  
	     	 AND CLASSES_ID =  #{classesId,jdbcType=VARCHAR} 
		</if>
	</where> 
  </select>
  
  <select id="queryAllStudentShop" resultMap="BaseResultMap" parameterType="com.xue.dto.OpenCourseRecodeQuery">
 select si.student_id,si.student_name,si.mobile,s.SHOP_NAME,buss.create_Time FROM 
 student_info si inner JOIN 
 bs_user_shop_set buss 
on si.student_id=buss.stu_id inner JOIN shop S 
ON buss.SHOP_ID = S.SHOP_ID    
 <where>
   <if test="userId!=null and userId!=''">
      and user_id=#{userId,jdbcType=VARCHAR}
   </if>
   <if test="mobile !=null and mobile != ''">  
	     	and mobile =  #{mobile,jdbcType=VARCHAR} 
   </if>
   <if test="studentId !=null and studentId != ''">  
	     	AND student_Id =  #{studentId,jdbcType=VARCHAR} 
   </if>
    <if test="studentName !=null and studentName != ''">  
	     	AND student_Name =  #{studentName,jdbcType=VARCHAR} 
   </if>
   </where> 
    limit #{startNum,jdbcType=INTEGER},5
  </select>
  
<select id="getOpenCourseRecodeCount" resultType="java.lang.Integer" parameterType="com.xue.dto.OpenCourseRecodeQuery">
 select count(*) FROM 
 student_info si inner JOIN 
 bs_user_shop_set buss 
on si.student_id=buss.stu_id inner JOIN shop S 
ON buss.SHOP_ID = S.SHOP_ID    
 <where>
   <if test="userId!=null and userId!=''">
      and user_id=#{userId,jdbcType=VARCHAR}
   </if>
   <if test="mobile !=null and mobile != ''">  
	     	and mobile =  #{mobile,jdbcType=VARCHAR} 
   </if>
   <if test="studentId !=null and studentId != ''">  
	     	AND student_Id =  #{studentId,jdbcType=VARCHAR} 
   </if>
    <if test="studentName !=null and studentName != ''">  
	     	AND student_Name =  #{studentName,jdbcType=VARCHAR} 
   </if>
   </where>  
</select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from shop
    where SHOP_ID = #{shopId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.xue.model.BsUserShopSet" >
    insert into bs_user_shop_set (id, user_id, shop_id,
		stu_id, create_time, statu, major_id, major_name,classes_id,classes_name,shop_price)
		values (#{id,jdbcType=VARCHAR}, #{userId,jdbcType=VARCHAR},  #{shopId,jdbcType=VARCHAR}, #{stuId,jdbcType=VARCHAR},#{createTime,jdbcType=INTEGER}, #{statu,jdbcType=INTEGER},#{majorId,jdbcType=VARCHAR},#{majorName,jdbcType=VARCHAR},
		#{classesId,jdbcType=VARCHAR},#{classesName,jdbcType=VARCHAR},#{shopPrice,jdbcType=FLOAT})
  </insert>
  <insert id="insertSelective" parameterType="com.xue.model.Shop" >
    insert into shop
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="shopId != null" >
        SHOP_ID,
      </if>
      <if test="shopName != null" >
        SHOP_NAME,
      </if>
      <if test="shopDesc != null" >
        SHOP_DESC,
      </if>
      <if test="shopNum != null" >
        SHOP_NUM,
      </if>
      <if test="shopPrice != null" >
        SHOP_PRICE,
      </if>
      <if test="shopState != null" >
        SHOP_STATE,
      </if>
      <if test="shopType != null" >
        SHOP_TYPE,
      </if>
      <if test="shopPic != null" >
        SHOP_PIC,
      </if>
      <if test="validity != null" >
        VALIDITY,
      </if>
      <if test="discount != null" >
        DISCOUNT,
      </if>
      <if test="orderBy != null" >
        ORDER_BY,
      </if>
      <if test="payWay != null" >
        PAY_WAY,
      </if>
      <if test="paySource != null" >
        PAY_SOURCE,
      </if>
      <if test="isDel != null" >
        IS_DEL,
      </if>
      <if test="payNumber != null" >
        PAY_NUMBER,
      </if>
      <if test="studyTime != null" >
        STUDY_TIME,
      </if>
      <if test="majorId != null" >
        MAJOR_ID,
      </if>
      <if test="majorName != null" >
        MAJOR_NAME,
      </if>
      <if test="subjectId != null" >
        SUBJECT_ID,
      </if>
      <if test="subjectName != null" >
        SUBJECT_NAME,
      </if>
      <if test="classesId != null" >
        CLASSES_ID,
      </if>
      <if test="classesName != null" >
        CLASSES_NAME,
      </if>
      <if test="classesOrder != null" >
        CLASSES_ORDER,
      </if>
      <if test="description != null" >
        DESCRIPTION,
      </if>
      <if test="phaseNumber != null" >
        PHASE_NUMBER,
      </if>
      <if test="liveUrl != null" >
        LIVE_URL,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="shopId != null" >
        #{shopId,jdbcType=VARCHAR},
      </if>
      <if test="shopName != null" >
        #{shopName,jdbcType=VARCHAR},
      </if>
      <if test="shopDesc != null" >
        #{shopDesc,jdbcType=VARCHAR},
      </if>
      <if test="shopNum != null" >
        #{shopNum,jdbcType=INTEGER},
      </if>
      <if test="shopPrice != null" >
        #{shopPrice,jdbcType=REAL},
      </if>
      <if test="shopState != null" >
        #{shopState,jdbcType=INTEGER},
      </if>
      <if test="shopType != null" >
        #{shopType,jdbcType=VARCHAR},
      </if>
      <if test="shopPic != null" >
        #{shopPic,jdbcType=VARCHAR},
      </if>
      <if test="validity != null" >
        #{validity,jdbcType=TIMESTAMP},
      </if>
      <if test="discount != null" >
        #{discount,jdbcType=REAL},
      </if>
      <if test="orderBy != null" >
        #{orderBy,jdbcType=INTEGER},
      </if>
      <if test="payWay != null" >
        #{payWay,jdbcType=VARCHAR},
      </if>
      <if test="paySource != null" >
        #{paySource,jdbcType=VARCHAR},
      </if>
      <if test="isDel != null" >
        #{isDel,jdbcType=INTEGER},
      </if>
      <if test="payNumber != null" >
        #{payNumber,jdbcType=INTEGER},
      </if>
      <if test="studyTime != null" >
        #{studyTime,jdbcType=VARCHAR},
      </if>
      <if test="majorId != null" >
        #{majorId,jdbcType=VARCHAR},
      </if>
      <if test="majorName != null" >
        #{majorName,jdbcType=VARCHAR},
      </if>
      <if test="subjectId != null" >
        #{subjectId,jdbcType=VARCHAR},
      </if>
      <if test="subjectName != null" >
        #{subjectName,jdbcType=VARCHAR},
      </if>
      <if test="classesId != null" >
        #{classesId,jdbcType=VARCHAR},
      </if>
      <if test="classesName != null" >
        #{classesName,jdbcType=VARCHAR},
      </if>
      <if test="classesOrder != null" >
        #{classesOrder,jdbcType=INTEGER},
      </if>
      <if test="description != null" >
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="phaseNumber != null" >
        #{phaseNumber,jdbcType=INTEGER},
      </if>
      <if test="liveUrl != null" >
        #{liveUrl,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.xue.model.Shop" >
    update shop
    <set >
      <if test="shopName != null" >
        SHOP_NAME = #{shopName,jdbcType=VARCHAR},
      </if>
      <if test="shopDesc != null" >
        SHOP_DESC = #{shopDesc,jdbcType=VARCHAR},
      </if>
      <if test="shopNum != null" >
        SHOP_NUM = #{shopNum,jdbcType=INTEGER},
      </if>
      <if test="shopPrice != null" >
        SHOP_PRICE = #{shopPrice,jdbcType=REAL},
      </if>
      <if test="shopState != null" >
        SHOP_STATE = #{shopState,jdbcType=INTEGER},
      </if>
      <if test="shopType != null" >
        SHOP_TYPE = #{shopType,jdbcType=VARCHAR},
      </if>
      <if test="shopPic != null" >
        SHOP_PIC = #{shopPic,jdbcType=VARCHAR},
      </if>
      <if test="validity != null" >
        VALIDITY = #{validity,jdbcType=TIMESTAMP},
      </if>
      <if test="discount != null" >
        DISCOUNT = #{discount,jdbcType=REAL},
      </if>
      <if test="orderBy != null" >
        ORDER_BY = #{orderBy,jdbcType=INTEGER},
      </if>
      <if test="payWay != null" >
        PAY_WAY = #{payWay,jdbcType=VARCHAR},
      </if>
      <if test="paySource != null" >
        PAY_SOURCE = #{paySource,jdbcType=VARCHAR},
      </if>
      <if test="isDel != null" >
        IS_DEL = #{isDel,jdbcType=INTEGER},
      </if>
      <if test="payNumber != null" >
        PAY_NUMBER = #{payNumber,jdbcType=INTEGER},
      </if>
      <if test="studyTime != null" >
        STUDY_TIME = #{studyTime,jdbcType=VARCHAR},
      </if>
      <if test="majorId != null" >
        MAJOR_ID = #{majorId,jdbcType=VARCHAR},
      </if>
      <if test="majorName != null" >
        MAJOR_NAME = #{majorName,jdbcType=VARCHAR},
      </if>
      <if test="subjectId != null" >
        SUBJECT_ID = #{subjectId,jdbcType=VARCHAR},
      </if>
      <if test="subjectName != null" >
        SUBJECT_NAME = #{subjectName,jdbcType=VARCHAR},
      </if>
      <if test="classesId != null" >
        CLASSES_ID = #{classesId,jdbcType=VARCHAR},
      </if>
      <if test="classesName != null" >
        CLASSES_NAME = #{classesName,jdbcType=VARCHAR},
      </if>
      <if test="classesOrder != null" >
        CLASSES_ORDER = #{classesOrder,jdbcType=INTEGER},
      </if>
      <if test="description != null" >
        DESCRIPTION = #{description,jdbcType=VARCHAR},
      </if>
      <if test="phaseNumber != null" >
        PHASE_NUMBER = #{phaseNumber,jdbcType=INTEGER},
      </if>
      <if test="liveUrl != null" >
        LIVE_URL = #{liveUrl,jdbcType=VARCHAR},
      </if>
    </set>
    where SHOP_ID = #{shopId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.xue.model.Shop" >
    update shop
    set SHOP_NAME = #{shopName,jdbcType=VARCHAR},
      SHOP_DESC = #{shopDesc,jdbcType=VARCHAR},
      SHOP_NUM = #{shopNum,jdbcType=INTEGER},
      SHOP_PRICE = #{shopPrice,jdbcType=REAL},
      SHOP_STATE = #{shopState,jdbcType=INTEGER},
      SHOP_TYPE = #{shopType,jdbcType=VARCHAR},
      SHOP_PIC = #{shopPic,jdbcType=VARCHAR},
      VALIDITY = #{validity,jdbcType=TIMESTAMP},
      DISCOUNT = #{discount,jdbcType=REAL},
      ORDER_BY = #{orderBy,jdbcType=INTEGER},
      PAY_WAY = #{payWay,jdbcType=VARCHAR},
      PAY_SOURCE = #{paySource,jdbcType=VARCHAR},
      IS_DEL = #{isDel,jdbcType=INTEGER},
      PAY_NUMBER = #{payNumber,jdbcType=INTEGER},
      STUDY_TIME = #{studyTime,jdbcType=VARCHAR},
      MAJOR_ID = #{majorId,jdbcType=VARCHAR},
      MAJOR_NAME = #{majorName,jdbcType=VARCHAR},
      SUBJECT_ID = #{subjectId,jdbcType=VARCHAR},
      SUBJECT_NAME = #{subjectName,jdbcType=VARCHAR},
      CLASSES_ID = #{classesId,jdbcType=VARCHAR},
      CLASSES_NAME = #{classesName,jdbcType=VARCHAR},
      CLASSES_ORDER = #{classesOrder,jdbcType=INTEGER},
      DESCRIPTION = #{description,jdbcType=VARCHAR},
      PHASE_NUMBER = #{phaseNumber,jdbcType=INTEGER},
      LIVE_URL = #{liveUrl,jdbcType=VARCHAR}
    where SHOP_ID = #{shopId,jdbcType=VARCHAR}
  </update>
</mapper>